# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

YouTube Video Downloader - A self-hosted Flask web application for downloading YouTube videos using yt-dlp. Provides a dark-themed UI with progress tracking, format selection, and browser cookie authentication support.

## Commands

```bash
# Activate the virtual environment
source venv/bin/activate

# Run the application (starts on port 5051)
python app.py

# Server accessible at http://localhost:5051 and from local network
```

## System Requirements

- **Python 3.12+** (via Homebrew: `brew install python@3.12`)
- **Node.js** (for YouTube signature solving: `brew install node`)
- **ffmpeg** (auto-detected from common locations)
- **Docker** (for PO token server - required for YouTube downloads)

### PO Token Server (Required for YouTube)

YouTube requires Proof of Origin (PO) tokens for video downloads. The PO token server generates these tokens automatically.

```bash
# Start the server (runs in background, restarts automatically)
docker run -d --name pot-server -p 4416:4416 --restart unless-stopped brainicism/bgutil-ytdlp-pot-provider

# Check if running
docker ps | grep pot-server

# Start if stopped
docker start pot-server
```

### Virtual Environment Setup

The app uses a Python 3.12 venv at `./venv/`:

```bash
/opt/homebrew/bin/python3.12 -m venv venv
source venv/bin/activate
pip install flask waitress yt-dlp yt-dlp-ejs bgutil-ytdlp-pot-provider yt-dlp-get-pot
```

### launchd Service (macOS)

The app runs as a launchd service for auto-start:

**Plist location:** `~/Library/LaunchAgents/com.nekonya.ytdownloader.plist`

```bash
# Stop
launchctl stop com.nekonya.ytdownloader

# Start
launchctl start com.nekonya.ytdownloader

# Reload config after plist changes
launchctl unload ~/Library/LaunchAgents/com.nekonya.ytdownloader.plist
launchctl load ~/Library/LaunchAgents/com.nekonya.ytdownloader.plist
```

The plist is configured to:
- Use Python from `./venv/bin/python`
- Set PATH to include `/opt/homebrew/bin` (for Node.js access)
- Set authentication env vars (`YT_AUTH_USER`, `YT_AUTH_PASS`, `YT_AUTH_ENABLED`)
- Auto-restart if crashed (`KeepAlive: true`)

## Authentication & Rate Limiting

The app includes security features for network deployment:

**Authentication** (enabled by default):
```bash
# Environment variables
YT_AUTH_ENABLED=true   # Enable/disable auth
YT_AUTH_USER=admin     # Username (default: admin)
YT_AUTH_PASS=changeme  # Password (default: changeme)
```

**Rate Limiting**:
- Downloads: 10 per 10 minutes per IP (configurable via `DOWNLOAD_RATE_LIMIT`, `DOWNLOAD_RATE_WINDOW`)
- yt-dlp updates: 5 minute cooldown (`UPDATE_COOLDOWN`)

## Architecture

**Stack:** Python/Flask backend + vanilla JavaScript/HTML/CSS frontend

```
Flask Backend (app.py)
├── Routes: /, /info, /download, /progress/<id>, /file/<name>, /downloads, /ytdlp-version, /update-ytdlp
├── yt-dlp integration for video extraction
├── Background thread downloads with progress tracking
├── Node.js runtime for YouTube signature solving (js_runtimes)
└── Browser cookie authentication (Brave, Chrome, Firefox, Safari, Edge)
           ↕ REST API (JSON)
Frontend (templates/ + static/)
├── youtube.html - HTML structure
├── youtube.js - API calls, polling, UI state management
└── youtube.css - Dark theme with CSS custom properties
```

**Download Flow:**
1. `POST /info` → Extract metadata with yt-dlp (no download)
2. `POST /download` → Start background thread, returns download ID
3. `GET /progress/<id>` → Poll every 500ms for progress
4. File saved to `./downloads/`, served via `GET /file/<name>`

**Key Backend Details:**
- `download_progress` dict tracks active downloads in memory
- `progress_hook()` callback updates progress during yt-dlp download
- `get_ffmpeg_location()` auto-detects ffmpeg on macOS/Linux/Windows
- Uses yt-dlp's `cookiesfrombrowser` for authenticated downloads
- `js_runtimes` configured to use Node.js (`/opt/homebrew/bin/node`) for YouTube signature solving
- Format selection: `bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best`
- Format options: best (up to 4K)/1080p/720p/480p/360p/audio-only (MP3/FLAC)
- `GET /ytdlp-version` returns current yt-dlp version
- `POST /update-ytdlp` upgrades yt-dlp via pip
- `GET /downloads` lists all downloaded files

**Key Frontend Details:**
- Polls `/progress/<id>` at 500ms intervals
- State variables: `currentUrl`, `currentBrowser`, format selection
- Helper functions: `formatDuration`, `formatViews`, `formatBytes`, `escapeHtml`
- Footer shows yt-dlp version with update button

## Recent Changes (January 2026)

### YouTube Anti-Bot Bypass

YouTube implemented stricter anti-bot measures requiring:

1. **PO (Proof of Origin) tokens** - Generated by Docker container `brainicism/bgutil-ytdlp-pot-provider` on port 4416
2. **JavaScript signature solving** - Requires Node.js runtime configured via `js_runtimes` option
3. **Proper format selection** - Simple format strings work best: `bestvideo[ext=mp4]+bestaudio[ext=m4a]/best`

### Changes Made:
- Upgraded from system Python 3.9 to Python 3.12 (via Homebrew venv)
- Added `js_runtimes` configuration pointing to `/opt/homebrew/bin/node`
- Installed yt-dlp plugins: `yt-dlp-ejs`, `bgutil-ytdlp-pot-provider`, `yt-dlp-get-pot`
- Updated launchd plist to use venv Python and set proper PATH
- Simplified format strings (removed complex protocol filters that caused fallback to 360p)

## Troubleshooting

### "The downloaded file is empty" error

YouTube is blocking the download. Check:

1. **Docker PO token server running:**
   ```bash
   docker ps | grep pot-server
   docker start pot-server  # if not running
   ```

2. **Node.js installed:**
   ```bash
   node --version  # Should show v25.x or similar
   ```

3. **Browser cookies selected** in the UI dropdown

4. **yt-dlp up to date:**
   ```bash
   source venv/bin/activate && pip install --upgrade yt-dlp
   ```

### Low quality downloads (360p instead of 720p+)

- Check format strings in `app.py` - complex protocol filters can cause fallback
- Current working format: `bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best`

## Project Status

This project is feature-complete and stable. No new features are planned.
